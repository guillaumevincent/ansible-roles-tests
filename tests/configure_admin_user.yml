---
- hosts: test
  become: yes
  become_user: root

  tasks:
    - name: Check /etc/sudoers.d/admin file exists
      stat:
        path: "/etc/sudoers.d/{{ ADMIN_USERNAME }}"
      register: stat_result

    - assert:
        that: stat_result.stat.exists
        msg: "/etc/sudoers.d/admin file doesn't exists"

    - name: Check /etc/sudoers.d stat folder
      shell: stat --printf='%a %U %G' /etc/sudoers.d
      register: sudoers_stat

    - assert:
        that: sudoers_stat.stdout == "755 root root"
        msg: got '{{sudoers_stat.stdout}}' expected '755 root root'

    - name: Check admin user sudoer
      shell: "grep 'admin ALL=(ALL) NOPASSWD: ALL' /etc/sudoers.d/admin"
      register: admin_user_sudoer

    - assert:
        that: admin_user_sudoer.stdout != ""

